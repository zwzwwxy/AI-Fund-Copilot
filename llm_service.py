from openai import OpenAI
from config import LLM_API_KEY, LLM_BASE_URL, LLM_MODEL

class LLMService:
    def __init__(self):
        if not LLM_API_KEY:
            self.client = None
            print("[WARN] [LLM] API Key æœªé…ç½®")
        else:
            self.client = OpenAI(api_key=LLM_API_KEY, base_url=LLM_BASE_URL)
            print(f"[OK] [LLM] åˆå§‹åŒ–æˆåŠŸï¼Œä½¿ç”¨æ¨¡å‹: {LLM_MODEL}")

    def generate_report(self, info, metrics, news):
        if not self.client:
            return "âš ï¸ API Key æœªé…ç½®"

        system_prompt = """
        ä½ æ˜¯ä¸€ä½æ‹¥æœ‰15å¹´ç»éªŒçš„èµ„æ·±åŸºé‡‘åˆ†æå¸ˆï¼Œæ“…é•¿åŸºæœ¬é¢å½’å› ä¸é‡åŒ–æ‹©æ—¶ã€‚
        è¯·åŸºäºæä¾›çš„æ•°æ®ï¼Œå†™ä¸€ä»½æ·±åº¦åˆ†æç ”æŠ¥ã€‚æ‹’ç»æ¨¡æ£±ä¸¤å¯çš„åºŸè¯ï¼Œå¿…é¡»æœ‰é€»è¾‘æ¨å¯¼ã€‚

        è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ Markdown æ ¼å¼è¾“å‡ºï¼š

        ## 1. æ ¸å¿ƒè§‚ç‚¹ (ä¸€å¥è¯æ€»ç»“)
        *   **è¯„çº§**ï¼š[å¼ºçƒˆæ¨è/æ¨è/è§‚æœ›/å‡æŒ] (è¯„åˆ†: X/10)
        *   **ç»“è®º**ï¼šç”¨æœ€ç®€ç»ƒçš„è¯­è¨€æ¦‚æ‹¬æ˜¯è¯¥ä¹°è¿˜æ˜¯è¯¥è·‘ã€‚

        ## 2. ä¸€å¥è¯æ“ä½œå»ºè®® â­
        *   **æ“ä½œæ–¹å‘**ï¼š[ç«‹å³ä¹°å…¥/åˆ†æ‰¹ä¹°å…¥/æŒæœ‰è§‚æœ›/åˆ†æ‰¹å–å‡º/ç«‹å³æ¸…ä»“]
        *   **å»ºè®®é…ç½®**ï¼šå»ºè®®æŠ•å…¥ XXX å…ƒæˆ–æ€»ä»“ä½çš„ XX%ï¼ˆé€‚åˆé“¶è¡ŒAPPä¸€æ¬¡æ€§ä¹°å…¥ï¼Œç»™å…·ä½“æ•°å­—ï¼‰
        *   **ç´§æ€¥ç¨‹åº¦**ï¼š[é«˜/ä¸­/ä½] - ç®€è¦è¯´æ˜ä¸ºä½•ç°åœ¨éœ€è¦æ“ä½œ

        ## 3. å®šæŠ•è®¾ç½®æŒ‡å¼•ï¼ˆé“¶è¡ŒAPPä¸“ç”¨ï¼‰â­
        *   **æ˜¯å¦å¼€å¯å®šæŠ•**ï¼šå»ºè®® [å¼€å¯/æš‚åœ/å–æ¶ˆ] ç°æœ‰å®šæŠ•
        *   **å®šæŠ•é‡‘é¢**ï¼šå»ºè®® XXX å…ƒ/å‘¨ æˆ– XXX å…ƒ/æœˆï¼ˆé“¶è¡ŒAPPå¯ç›´æ¥è®¾ç½®ï¼‰
        *   **è°ƒæ•´å»ºè®®**ï¼šå¦‚æœå·²æœ‰å®šæŠ•ï¼Œå»ºè®® [å¢åŠ /å‡å°‘/ä¿æŒ] å®šæŠ•é‡‘é¢

        ## 4. é“¶è¡ŒAPPæ“ä½œæ­¥éª¤ â­
        *   **ä¹°å…¥æ“ä½œ**ï¼šæ‰“å¼€é“¶è¡ŒAPP â†’ æœç´¢"XXXåŸºé‡‘ä»£ç " â†’ ç‚¹å‡»"ä¹°å…¥" â†’ è¾“å…¥é‡‘é¢ XXX å…ƒ
        *   **å®šæŠ•è®¾ç½®**ï¼šåŸºé‡‘è¯¦æƒ…é¡µ â†’ ç‚¹å‡»"å®šæŠ•/è‡ªåŠ¨æŠ•èµ„" â†’ è®¾ç½®å‘¨æœŸï¼ˆå‘¨/æœˆï¼‰â†’ è¾“å…¥é‡‘é¢ XXX å…ƒ â†’ ç¡®è®¤
        *   **é‡è¦æé†’**ï¼š
            *   äº¤æ˜“æ—¶é—´ï¼šå·¥ä½œæ—¥ 9:30-15:00ï¼ˆ15:00å‰æŒ‰å½“æ—¥å‡€å€¼æˆäº¤ï¼‰
            *   é“¶è¡ŒAPPä¸æ”¯æŒç½‘æ ¼äº¤æ˜“ï¼Œä»…æ”¯æŒä¸€æ¬¡æ€§ä¹°å…¥å’Œå®šæŠ•

        ## 5. ä¸šç»©å½’å› åˆ†æ
        *   **æ”¶ç›Šè¡¨ç°**ï¼šè¿‘1å¹´æ”¶ç›Š {ret_1y}ã€‚ç»“åˆå¤æ™®æ¯”ç‡({sharpe})åˆ†æï¼Œè¯¥åŸºé‡‘æ˜¯"é«˜æ³¢é«˜æ”¶ç›Š"è¿˜æ˜¯"ç¨³å¥å¢é•¿"ï¼Ÿ
        *   **è¶‹åŠ¿åˆ¤æ–­**ï¼šå½“å‰å¤„äº"{trend}"ã€‚ç»“åˆä»·æ ¼åˆ†ä½({rank}/100)ï¼Œåˆ†æå½“å‰æ˜¯å±±é¡¶ç«™å²—é£é™©ï¼Œè¿˜æ˜¯åº•éƒ¨åè½¬æœºä¼šï¼Ÿ

        ## 6. æŒä»“ä¸èµ›é“é€»è¾‘
        *   **é‡ä»“è§£æ**ï¼šåŸºäºå‰äº”å¤§é‡ä»“è‚¡({holdings})ï¼Œåˆ¤æ–­è¯¥åŸºé‡‘æŠ¼æ³¨çš„ç»†åˆ†èµ›é“ï¼ˆå¦‚ï¼šæ˜¯ç™½é…’è¿˜æ˜¯åŠå¯¼ä½“ï¼Ÿï¼‰ã€‚
        *   **æ–°é—»æ˜ å°„**ï¼šç»“åˆæä¾›çš„èµ„è®¯ï¼Œåˆ†æè¿™äº›è¡Œä¸šå½“ä¸‹çš„æ”¿ç­–ç¯å¢ƒæˆ–å¸‚åœºæƒ…ç»ªï¼ˆåˆ©å¥½/åˆ©ç©ºï¼‰ã€‚

        ## 7. é£é™©ä¸å›æ’¤
        *   å½“å‰å›æ’¤ {current_dd}ï¼Œè¿‘ä¸€å¹´æœ€å¤§å›æ’¤ {max_dd_1y}ã€‚
        *   è¯·è¯„ä»·è¯¥å›æ’¤å¹…åº¦æ˜¯å¦åœ¨åŒç±»åŸºé‡‘çš„å¯æ¥å—èŒƒå›´å†…ï¼Ÿå¦‚æœä¸æ­£å¸¸ï¼Œå¯èƒ½çš„åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ

        ## 8. è¿›é˜¶ç­–ç•¥ï¼ˆé€‚åˆä¸“ä¸šæŠ•èµ„è€…ï¼‰â­
        *   **ç½‘æ ¼äº¤æ˜“**ï¼š(ä»…é’ˆå¯¹ETF) âš ï¸ é“¶è¡ŒAPPä¸æ”¯æŒè‡ªåŠ¨ç½‘æ ¼ï¼Œå¦‚éœ€æ‰‹åŠ¨æ¨¡æ‹Ÿï¼Œå¯æŒ‰å½“å‰ä»·ä¸Šä¸‹ Â±X% åˆ†æ‰¹æŒ‚å•
        *   **ä»“ä½ç®¡ç†**ï¼šæ‰‹åŠ¨åˆ†æ‰¹ç­–ç•¥å»ºè®®ï¼šå¦‚åº•ä»“3æˆï¼ˆä¸€æ¬¡æ€§ï¼‰ï¼Œæ¯è·ŒX%åŠ 1æˆï¼ˆæ‰‹åŠ¨æ“ä½œï¼‰
        *   **æŠ€æœ¯ç­–ç•¥**ï¼š(å¦‚æœ‰) å‹åŠ›ä½ã€æ”¯æ’‘ä½ã€å‡çº¿çªç ´ç­‰ä¿¡å·ï¼ˆä»…ä¾›å‚è€ƒï¼‰
        """

        user_content = f"""
        ã€åŸºé‡‘æ¡£æ¡ˆã€‘
        ä»£ç : {info.get('code')}
        åç§°: {info['name']}
        ç»ç†: {info['manager']}
        æŒä»“æŠ¥å‘ŠæœŸ: {info.get('report_date', 'Unknown')}
        é‡ä»“è‚¡: {', '.join(info['top_holdings'])}

        ã€é‡åŒ–æŒ‡æ ‡ã€‘
        - æœ€æ–°ä»·æ ¼: {metrics['price']}
        - è¶‹åŠ¿å½¢æ€: {metrics['trend']} (å‡çº¿çŠ¶æ€)
        - ä»·æ ¼ä½ç½®: å¤„äºè¿‘ä¸€å¹´ {metrics['rank']}% çš„åˆ†ä½ç‚¹ (0=æœ€ä½, 100=æœ€é«˜)
        - æ³¢åŠ¨ç‡: {metrics['volatility']}
        - å¤æ™®æ¯”ç‡(æ—¥é¢‘): {metrics['sharpe']}
        - å¤æ™®æ¯”ç‡(å‘¨é¢‘/å·¥è¡Œæ ‡å‡†,æ— é£é™©åˆ©ç‡:{metrics.get('sharpe_weekly_rf', 'N/A')}):
          * è¿‘1å¹´: {metrics.get('sharpe_weekly_1å¹´', 'N/A')}
          * è¿‘2å¹´: {metrics.get('sharpe_weekly_2å¹´', 'N/A')}
          * è¿‘3å¹´: {metrics.get('sharpe_weekly_3å¹´', 'N/A')}
        - åŠ¨æ€å›æ’¤: {metrics['current_dd']} (è·ç¦»å†å²é«˜ç‚¹)
        - æé™å›æ’¤: {metrics['max_dd_1y']} (è¿‘ä¸€å¹´æœ€å·®æƒ…å†µ)
        - æŠ€æœ¯æŒ‡æ ‡: {metrics['tech']}

        ã€å¸‚åœºèµ„è®¯ä¸èˆ†æƒ…ã€‘
        {news}
        """

        print(f"  [LLM] æ­£åœ¨ä¸º {info['name']} ç”Ÿæˆåˆ†ææŠ¥å‘Š...")
        print(f"  [LLM] è¾“å…¥é¢„è§ˆ: ä»·æ ¼={metrics['price']}, è¶‹åŠ¿={metrics['trend']}")
        print(f"  [LLM] å¤æ™®={metrics['sharpe']}, ä½ç½®={metrics['rank']}%, é‡ä»“è‚¡æ•°={len(info['top_holdings'])}")

        try:
            resp = self.client.chat.completions.create(
                model=LLM_MODEL,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_content}
                ],
                temperature=0.7
            )
            report = resp.choices[0].message.content
            report_len = len(report) if report else 0
            print(f"  [OK] [LLM] {info['name']} æŠ¥å‘Šç”ŸæˆæˆåŠŸ ({report_len} å­—ç¬¦)")
            return report
        except Exception as e:
            print(f"  [ERROR] [LLM] {info['name']} è°ƒç”¨å¤±è´¥: {e}")
            return f"LLM è°ƒç”¨å‡ºé”™: {e}"

    def generate_holdings_report(self, portfolio_summary: dict, position_details: list):
        if not self.client:
            return "âš ï¸ API Key æœªé…ç½®"

        if not position_details:
            return None

        positions_text = ""
        for p in position_details:
            profit_emoji = "ğŸ“ˆ" if p.get('profit_loss', 0) >= 0 else "ğŸ“‰"
            positions_text += f"""
### {p.get('code')} - {p.get('name', '')} {profit_emoji}
- **æŒä»“ä»½é¢**: {p.get('shares', 0)} ä»½
- **æŒä»“æˆæœ¬**: {p.get('avg_cost', 0):.3f} å…ƒ
- **å½“å‰ä»·æ ¼**: {p.get('current_price', 0):.3f} å…ƒ
- **æŒä»“é‡‘é¢**: {p.get('current_value', 0):.2f} å…ƒ
- **æŒä»“ç›ˆäº**: {p.get('profit_loss', 0):.2f} å…ƒ ({p.get('profit_loss_pct', 0):.2f}%)
- **æˆæœ¬ä½ç½®**: å½“å‰ä»·æ ¼æ¯”æˆæœ¬{'é«˜' if p.get('cost_position', 0) >= 0 else 'ä½'} {abs(p.get('cost_position', 0)):.2f}%
"""

        system_prompt = """
        ä½ æ˜¯ä¸€ä½èµ„æ·±çš„åŸºé‡‘æŠ•èµ„é¡¾é—®ï¼Œæ“…é•¿æ ¹æ®ç”¨æˆ·çš„ä¸ªäººæŒä»“æƒ…å†µæä¾›ä¸ªæ€§åŒ–çš„æŠ•èµ„å»ºè®®ã€‚

        è¯·åŸºäºç”¨æˆ·æä¾›ä¸ªäººæŒä»“æ•°æ®ï¼ˆåŒ…å«æŒä»“æˆæœ¬ã€å½“å‰ç›ˆäºç­‰ä¿¡æ¯ï¼‰ï¼Œç”Ÿæˆä¸€ä»½ç®€æ´å®ç”¨çš„ä¸ªäººæŒä»“åˆ†ææŠ¥å‘Šã€‚

        æŠ¥å‘Šè¦æ±‚ï¼š
        1. **æ•´ä½“è¯„ä¼°**ï¼šç”¨1-2å¥è¯æ¦‚æ‹¬å½“å‰æŒä»“çš„æ•´ä½“ç›ˆäºçŠ¶æ€
        2. **æŒä»“è¯Šæ–­**ï¼šåˆ†ææ¯åªæŒä»“çš„æˆæœ¬æ˜¯å¦åˆç†ã€æ˜¯å¦éœ€è¦è°ƒæ•´
        3. **æ“ä½œå»ºè®®**ï¼šé’ˆå¯¹äºæŸæŒä»“ç»™å‡ºè¡¥ä»“/æ­¢æŸå»ºè®®ï¼Œé’ˆå¯¹ç›ˆåˆ©æŒä»“ç»™å‡ºæ­¢ç›ˆ/æŒæœ‰å»ºè®®
        4. **ä»“ä½ä¼˜åŒ–**ï¼šæ ¹æ®æ•´ä½“æŒä»“æƒ…å†µï¼Œç»™å‡ºæ˜¯å¦éœ€è¦åŠ ä»“æˆ–å‡ä»“çš„å»ºè®®

        ç‰¹åˆ«æ³¨æ„ï¼š
        - å¯¹äºäºæŸè¶…è¿‡10%çš„æŒä»“ï¼Œé‡ç‚¹åˆ†æåŸå› å¹¶ç»™å‡ºæ“ä½œå»ºè®®
        - å¯¹äºç›ˆåˆ©è¶…è¿‡20%çš„æŒä»“ï¼Œåˆ†ææ˜¯å¦éœ€è¦æ­¢ç›ˆ
        - å»ºè®®è¦å…·ä½“ã€å¯æ‰§è¡Œï¼ˆé€‚åˆé“¶è¡ŒAPPæ“ä½œï¼‰
        - ç”¨emojiå¢å¼ºå¯è¯»æ€§
        """

        user_content = f"""
        ã€ä¸ªäººæŒä»“æ¦‚å†µã€‘
        - æŒä»“æ€»é‡‘é¢: {portfolio_summary.get('total_value', 0):.2f} å…ƒ
        - æ€»æˆæœ¬: {portfolio_summary.get('total_cost', 0):.2f} å…ƒ
        - æ€»ç›ˆäº: {portfolio_summary.get('total_profit', 0):.2f} å…ƒ ({portfolio_summary.get('total_profit_pct', 0):.2f}%)
        - æŒä»“æ•°é‡: {portfolio_summary.get('position_count', 0)} åª
          - ETFæ•°é‡: {portfolio_summary.get('etf_count', 0)}
          - åœºå¤–åŸºé‡‘æ•°é‡: {portfolio_summary.get('mutual_count', 0)}
        - åˆ†ææ—¶é—´: {portfolio_summary.get('analysis_date', '')}

        ã€æŒä»“æ˜ç»†ã€‘
        {positions_text}
        """

        print(f"  [LLM] æ­£åœ¨ç”Ÿæˆä¸ªäººæŒä»“åˆ†ææŠ¥å‘Š...")

        try:
            resp = self.client.chat.completions.create(
                model=LLM_MODEL,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_content}
                ],
                temperature=0.7
            )
            report = resp.choices[0].message.content
            report_len = len(report) if report else 0
            print(f"  [OK] [LLM] æŒä»“åˆ†ææŠ¥å‘Šç”ŸæˆæˆåŠŸ ({report_len} å­—ç¬¦)")
            return report
        except Exception as e:
            print(f"  [ERROR] [LLM] æŒä»“åˆ†ææŠ¥å‘Šè°ƒç”¨å¤±è´¥: {e}")
            return f"LLM è°ƒç”¨å‡ºé”™: {e}"
